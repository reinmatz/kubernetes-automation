Kubernetes.io

**WSL Tab-Completion:**
student@SR15-22:~$ kubectl completion bash | sudo tee /etc/bash_completion.d/kubectl^C
student@SR15-22:~$ source /etc/bash_completion.d/kubectl 
ku
**Kubernetes Cluster Informationen:**
.kube/config
kubectl config get-contexts 

**Namespace:**
kubectl api-resources --namespaced=true
kubectl api-resources 

Pod:
kubectl explain pod

history 
    1  exit
    2* 
    3  kubectl completion bash | sudo tee /etc/bash_completion.d/kubectl
    4  source /etc/bash_completion.d/kubectl 
    5  pwd
    6  ll
    7  cd .kube/
    8  ll
    9  cat config 
   10  cd ..
   11  kubectl config 
   12  kubectl config get-contexts 
   13  kubectl config get-clusters
   14  kubectl config get-users
   15  kubectl api-resources 
   16* kubectl api-resources --namespace=true
   17  kubectl explain pod
   18  kubectl api-resources
   19  kubectl api-resources --namespacend=true
   20  kubectl api-resources --namespaced=true
   21  kubectl api-resources --namespaced=true | wc
   22  kubectl explain pod
   23  kubectl config get-contexts 
   24  kubectl create namespace  rma-myfirst
   25  kubectl get namespaces 
   26  history 
   27  kubectl config set-context docker-desktop --namespace rma-myfirst 
   28  kubectl config get-contexts 
   29  kubectl run myhttpd --image quay.io/jfreygner/myhttpd:0.20
   30  kubectl get pods 
   31  kubectl get all
   32  history 
	kubectl exec -it myhttpd -- bash   --> kill 1
	kubectl get all
	
	kubectl delete pod myhttpd


**Deployment:**
student@SR15-22:~$ kubectl create deployment myhttpd --image quay.io/jfreygner/myhttpd:0.20
deployment.apps/myhttpd created
student@SR15-22:~$ kubectl get all
NAME                           READY   STATUS         RESTARTS   AGE
pod/myhttpd-6448bcc8d8-6gbvg   0/1     ErrImagePull   0          6s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/myhttpd   0/1     1            0           6s

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/myhttpd-6448bcc8d8   1         1         0       6s

student@SR15-22:~$ kubectl scale deployment myhttpd --replicas 3
deployment.apps/myhttpd scaled
student@SR15-22:~$ kubectl get all
NAME                           READY   STATUS             RESTARTS   AGE
pod/myhttpd-6448bcc8d8-6gbvg   0/1     ImagePullBackOff   0          3m57s
pod/myhttpd-6448bcc8d8-729l6   0/1     ErrImagePull       0          3s
pod/myhttpd-6448bcc8d8-9v47h   0/1     ErrImagePull       0          3s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/myhttpd   0/3     3            0           3m57s

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/myhttpd-6448bcc8d8   3         3         0       3m57s

student@SR15-22:~$ kubectl delete  pod myhttpd-6448bcc8d8-729l6 
pod "myhttpd-6448bcc8d8-729l6" deleted
student@SR15-22:~$ kubectl get all
NAME                           READY   STATUS             RESTARTS   AGE
pod/myhttpd-6448bcc8d8-6gbvg   0/1     ImagePullBackOff   0          5m49s
pod/myhttpd-6448bcc8d8-9v47h   0/1     ImagePullBackOff   0          115s
pod/myhttpd-6448bcc8d8-jszm8   0/1     ErrImagePull       0          6s

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/myhttpd   0/3     3            0           5m49s

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/myhttpd-6448bcc8d8   3         3         0       5m49s

student@SR15-22:~$ kubectl exec -it pod/myhttpd-6448bcc8d8-jszm8 -- bash

student@SR15-22:~$ kubectl get  pods -o wide

**Konfiguration anpassen vi:**
student@SR15-22:~$ kubectl edit deployments.apps myhttpd 


**Netzwerk:**
student@SR15-22:~$ kubectl expose deployment myhttpd  --port 8080

kubectl get service

student@SR15-22:~$ kubectl describe service myhttpd 
Name:                     myhttpd
Namespace:                rma-myfirst
Labels:                   app=myhttpd
Annotations:              <none>
Selector:                 app=myhttpd
Type:                     ClusterIP
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       10.111.186.178
IPs:                      10.111.186.178
Port:                     <unset>  8080/TCP
TargetPort:               8080/TCP
Endpoints:                10.1.0.11:8080,10.1.0.13:8080,10.1.0.12:8080
Session Affinity:         None
Internal Traffic Policy:  Cluster
Events:                   <none>

**Extention**

  79  mkir -p setup/ingress
   80  mkdir -p setup/ingress
   81  cd setup/ingress/
   82  cp /mnt/c/Users/Administrator/Downloads/deploy.yaml .
   84  kubectl create -f  deploy.yaml 
   89  kubectl get ingressclasses.networking.k8s.io
   90  kubectl get all -n ingress-nginx
   92  kubectl get ingressclasses.networking.k8s.io 
   93  kubectl create ingress myhttpd --class nginx --rule "www.myfirst.local/*=myhttpd:8080"
   94  kubectl config get-contexts 
   95  kubectl get ingress
   96  kubectl get all
   97  ip a s
   98  echo "172.22.84.207 www.myfirst.local" | sudo tee -a /etc/hosts
   99  curl www.myfirst.local

**Zussammenfassung Tag1**

kubectl 
	- get 
	- config
	- describe Methadaten zu Resource , get <resource> <name> -o yaml (wide, json)
	- declarative --> create <resorce> ... , imperative --> create -f <file | dir>
	- delete <resource> <name> , delete -f <file|dir>
	- set <parameter> <resource> <name> ...
	- edit <resource> <name>
	- logs <podname>
	- exec <podname> -- <cmd>
	- expose <deployment> ...	
	- explain <resource>
	- run <name>
	- rollout <deployment>
	- scale <deployment> <name> --replicas ..
	- api-resources
	- get events --sort-by lastTimestamp Fehlersuche

Backup:	
kubectl get svc mymariadb -o yaml > mymariadb.yaml
kubectl get deploy,svc mymariadb -o yaml > mymariadb-all.yaml
# kubectl delete svc mymariadb
# kubectl delete all --all
kubectl create -f mymariadb.yaml

kubectl config set-cluster --help -- Verbindung zum Cluster 



kubectl exec myhttpd-746766bc85-2b2k9 -- cat /etc/httpd/conf/httpd.conf > httpd.conf
student@SR15-22:~/projects/myhttpd$ code httpd.conf 
student@SR15-22:~/projects/myhttpd$ ErrorLog "/dev/stderr"
ErrorLog: command not found
student@SR15-22:~/projects/myhttpd$ code httpd.conf 
student@SR15-22:~/projects/myhttpd$ CustomLog "/dev/stdout" combined

**Config Map**

student@SR15-22:~$ kubectl config set-context docker-desktop --namespace rma-myfirst 
Context "docker-desktop" modified.
student@SR15-22:~$ curl ww.myfirst.local
curl: (6) Could not resolve host: ww.myfirst.local
student@SR15-22:~$ curl www.myfirst.local
this is a testpage created by container-entrypoint script
student@SR15-22:~$ kubectl exec 
daemonsets/               myhttpd-746766bc85-2b2k9  pods/                     services/
deployments/              myhttpd-746766bc85-dgc5z  replicasets/              statefulsets/
jobs/                     myhttpd-746766bc85-nt9tp  replicationcontrollers/   
student@SR15-22:~$ kubectl exec 
daemonsets/               myhttpd-746766bc85-2b2k9  pods/                     services/
deployments/              myhttpd-746766bc85-dgc5z  replicasets/              statefulsets/
jobs/                     myhttpd-746766bc85-nt9tp  replicationcontrollers/   
student@SR15-22:~$ kubectl exec 
daemonsets/               myhttpd-746766bc85-2b2k9  pods/                     services/
deployments/              myhttpd-746766bc85-dgc5z  replicasets/              statefulsets/
jobs/                     myhttpd-746766bc85-nt9tp  replicationcontrollers/   
student@SR15-22:~$ kubectl exec myhttpd-746766bc85-
myhttpd-746766bc85-2b2k9  myhttpd-746766bc85-dgc5z  myhttpd-746766bc85-nt9tp  
student@SR15-22:~$ kubectl exec myhttpd-746766bc85-2b2k9 
error: you must specify at least one command for the container
student@SR15-22:~$ kubectl exec myhttpd-746766bc85-2b2k9  -- bash
student@SR15-22:~$ ls
mymariadb.yaml  setup
student@SR15-22:~$ kubectl exec -it  myhttpd-746766bc85-2b2k9  -- bash
student@SR15-22:~$ mkdir projects/myhttpd
mkdir: cannot create directory ‘projects/myhttpd’: No such file or directory
student@SR15-22:~$ mkdir  projects
student@SR15-22:~$ cd projects/ 
student@SR15-22:~/projects$ mdir myhttpd
Command 'mdir' not found, but can be installed with:
sudo apt install mtools
student@SR15-22:~/projects$ mkdir myhttpd
student@SR15-22:~/projects$ cd myhttpd/
student@SR15-22:~/projects/myhttpd$ pwd
/home/student/projects/myhttpd
student@SR15-22:~/projects/myhttpd$ kubectl get pods
NAME                       READY   STATUS    RESTARTS   AGE
myhttpd-746766bc85-2b2k9   1/1     Running   0          19h
myhttpd-746766bc85-dgc5z   1/1     Running   0          19h
myhttpd-746766bc85-nt9tp   1/1     Running   0          19h
student@SR15-22:~/projects/myhttpd$ kubectl cp myhttpd-746766bc85-2b2k9:/etc/httpd/conf/httpd.conf .
command terminated with exit code 127
student@SR15-22:~/projects/myhttpd$ kubectl exec myhttpd-746766bc85-2b2k9 -- cat  /etc/httpd/conf/httpd.conf  > httpd.conf
student@SR15-22:~/projects/myhttpd$ ls
httpd.conf
student@SR15-22:~/projects/myhttpd$ cat httpd.conf 


student@SR15-22:~/projects/myhttpd$ kubectl get cm
NAME               DATA   AGE
kube-root-ca.crt   1      20h
myhttpd            1      67s
student@SR15-22:~/projects/myhttpd$ kubectl get all,cm
NAME                           READY   STATUS    RESTARTS   AGE
pod/myhttpd-746766bc85-2b2k9   1/1     Running   0          19h
pod/myhttpd-746766bc85-dgc5z   1/1     Running   0          19h
pod/myhttpd-746766bc85-nt9tp   1/1     Running   0          19h

NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/myhttpd   ClusterIP   10.111.186.178   <none>        8080/TCP   19h

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/myhttpd   3/3     3            3           20h

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/myhttpd-6448bcc8d8   0         0         0       20h
replicaset.apps/myhttpd-746766bc85   3         3         3       19h

NAME                         DATA   AGE
configmap/kube-root-ca.crt   1      20h
configmap/myhttpd            1      80s



**oc command installation**

kubectl version

google --> openshift OC Client mirror 
google --> maping der version OC vs. kubernetes


https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.19.19/

  193  cd 
  194  wget https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.19.19/openshift-client-linux-4.19.19.tar.gz
  195  cd /usr/local/bin/
  196  sudo tar xf ~/openshift-client-linux-4.19.19.tar.gz oc
  197  oc version
  198  source /etc/bash_completion.d/oc
  199  oc completion bash | sudo tee /etc/bash_completion.d/oc
  200  source /etc/bash_completion.d/oc
  201  cd 
  202  oc set

student@SR15-22:~$ oc set volumes deployment myhttpd --add --name myhttpd-conf -t configmap --configmap-name myhttpd --mount -path /etc/httpd/conf/httpd.conf --sub-path httpd.conf

Änderungen:
student@SR15-22:~/projects/myhttpd$ oc set data configmap myhttpd --from-file httpd.conf

ConfigMap
Cofnig file oder env 

**Secret**
oc create secret

kubectl config set-context docker-desktop  --namespace rma-mymariadb
  220  read -s -p 'Passwort: '
  221  kubectl create secret generic mymariadb --from-literal MARIADB_ROOT_PASSWORD=$REPLY
  222  kubectl create secret generic rma-mymariadb --from-literal MARIADB_ROOT_PASSWORD=$REPLY
  223  kubectl create secret generic mydb --from-literal MARIADB_ROOT_PASSWORD=$REPLY
  224  kubectl create secret generic mymariadb --from-literal MARIADB_ROOT_PASSWORD=$REPLY
  225  kubectl config set-context docker-desktop --namespace rma-mymariadb
  226  kubectl get config
  227  kubectl get all
  228  kubectl config 
  229  kubectl config get-contexts 
  230  kubectl create secret generic rma-mymariadb --from-literal MARIADB_ROOT_PASSWORD=$REPLY
  231  read -s -p 'Passwort: '
  232  kubectl create secret generic mydb --from-literal MARIA_ROOT_PASSWORD=$REPLY
  233  cd 
  234  kubectl config get-contexts 
  235  kubectl create secret generic myaria --from-literal MARIA_ROOT_PASSWORD=$REPLY
  236  kubectl config get-contexts 
  237  kubectl get namespace
  238  kubectl config set-context docker-desktop --namespace rma-mariadb
  239  kubectl create secret generic mymaria --from-literal MARIA_ROOT_PASSWORD=$REPLY
  240  kubectl get all,secret
  241  kubectl set env deployment mymaria
  242  kubectl set env deployment mymaria --from secret/mymaria
  243  kubectl set env deployment mymaria --from secret/mymariadb
  244  kubectl set env deployment mymariadb --from secret/mymaria
  245  kubectl describe deployments.apps mymariadb 
  246  oc set data secret  mymaria --from-literal MARIADB_ROOT_PASSWORD=$REPLY
  247  kubectl set env deployment mymariadb --from secret/mymaria
  248  kubectl describe deployments.apps mymariadb 
  249  kubectl edit deployments.apps mymariadb 
  250  kubectl describe deployments.apps mymariadb 
  251  kubectl get -o yaml secrets mydb
  252  kubectl get -o yaml secrets mymariadb
  253  kubectl get -o yaml secrets mymaria
  254  kubectl exec mymariadb-fc666d67f-x9tcb -- env | grep MARIA
  255  kubectl get serviceaccounts 


Serviceaccount:
kubectl create secret docker-registry redhat-registry --docker-server registry.redhat.io --docker-username rma --docker-password $REPLY

kubectl get serviceaccounts

oc secrets link default redhat-registry --for pull

kubectl describe serviceaccounts default

kubectl get pods

kubectl get serviceaccounts default -o yaml


https://developers.redhat.com
https://console.redhat.com

**Storage**

Storage Plugin:
NAS (Filesystem)
SAN (Blockdevice)
Objectstore

PV - Persistent Volume <-- persistentvolumeclaim
Storage class

AccessMode:
rwm,rwo,r 

oc get sc

kubectl config set-context docker-desktop --namespace rma-myfirst 
curl www.myfirst.local
kubectl get pvc

oc set volumes deployment myhttpd --add --name myhttpd-data -t pvc --claim-size 5G --claim-name myhttpd --claim-mode rwm --mount-path /var/www/html 

oc get pods

Daten --> container entry point script oder oc rsync

kubectl config set-context docker-desktop --namespace rma-myfirst 
  261  kubectl get pods
  262  curl www.myfirst.local
  263  kubectl get pvc
  265  oc set volumes deployment myhttpd --add --name myhttpd-data -t pvc --claim-size 5G --claim-name myhttpd --claim-mode rwm --mount-path /var/www/html 
  266  oc get pods
  267  kubectl exec -it myhttpd-846bd886d4-8
  268  kubectl exec -it myhttpd-846bd886d4-89wz2 -- bash
	echo "test pesistent volume" > /var/www/html/http.conf
  269  kubectl scale deployment myhttpd --replicas 0
  270  kubectl get pods
  271  kubectl scale deployment myhttpd --replicas 3
  272  kubectl get pods
  274  curl www.myfirst.local


**Übung Statefulset**

kubectl get pv 
Achtung:	RECLAIM POLICY Delete löscht alle Daten sondern Retain einstellen

  305  cd projects/mydb
  306  cd projects
  307  mkdir mymariadb
  308  kubectl get -o yaml deployments.apps mymariadb > mydb-deploy.yaml
  309  cp mydb-deploy.yaml mydb-statefulset.yaml 
  310  code mydb-statefulset.yaml 

mydb-statefulset.yaml	
``
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: mymariadb
  name: mymariadb
spec:
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: mymariadb
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: mymariadb
    spec:
      containers:
      - env:
        - name: MARIADB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              key: MARIADB_ROOT_PASSWORD
              name: mymaria
        image: docker.io/library/mariadb
        imagePullPolicy: Always
        name: mariadb
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /var/lib/mysql
          name: rma-mariadb-data
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
  volumeClaimTemplates:
  - metadata:
      name: rma-mariadb-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 5Gi
``

  324  kubectl delete -f mydb-statefulset.yaml 
  325  kubectl create -f mydb-statefulset.yaml 
  326  kubectl get pods,pvc










	







