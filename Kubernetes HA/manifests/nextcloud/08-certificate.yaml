---
# TLS Certificate für Nextcloud
# Erfordert Cert-Manager installiert im Cluster
# Cert-Manager erstellt automatisch Secret 'nextcloud-tls-secret'

# Option 1: Let's Encrypt Production (echte Zertifikate)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: nextcloud-tls
  namespace: nextcloud-prod
  labels:
    app: nextcloud
spec:
  secretName: nextcloud-tls-secret  # Secret wird hier gespeichert
  duration: 2160h  # 90 Tage
  renewBefore: 360h  # Erneuern 15 Tage vor Ablauf

  subject:
    organizations:
    - Nextcloud Production

  # Common Name und DNS-Namen
  commonName: nextcloud.yourdomain.com  # ← ÄNDERN!
  dnsNames:
  - nextcloud.yourdomain.com  # ← ÄNDERN!
  # - www.nextcloud.yourdomain.com  # Optional: Weitere Domains

  # Issuer-Referenz (Let's Encrypt)
  issuerRef:
    name: letsencrypt-prod  # ClusterIssuer (siehe unten)
    kind: ClusterIssuer
    group: cert-manager.io

---
# ClusterIssuer: Let's Encrypt Production
# Erstellt ECHTE Zertifikate (Rate Limits beachten!)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your-email@example.com  # ← ÄNDERN zu Ihrer E-Mail!

    # Private Key für Let's Encrypt Account
    privateKeySecretRef:
      name: letsencrypt-prod-account-key

    # HTTP-01 Challenge (über Ingress)
    solvers:
    - http01:
        ingress:
          class: nginx

---
# Alternative: Self-Signed ClusterIssuer (nur für Testing!)
# Erzeugt selbst-signierte Zertifikate (Browser-Warnung!)
# apiVersion: cert-manager.io/v1
# kind: ClusterIssuer
# metadata:
#   name: selfsigned-issuer
# spec:
#   selfSigned: {}

---
# Alternative: Let's Encrypt Staging (für Tests)
# Keine Rate Limits, aber Browser vertraut Zertifikaten NICHT
# apiVersion: cert-manager.io/v1
# kind: ClusterIssuer
# metadata:
#   name: letsencrypt-staging
# spec:
#   acme:
#     server: https://acme-staging-v02.api.letsencrypt.org/directory
#     email: your-email@example.com
#     privateKeySecretRef:
#       name: letsencrypt-staging-account-key
#     solvers:
#     - http01:
#         ingress:
#           class: nginx
