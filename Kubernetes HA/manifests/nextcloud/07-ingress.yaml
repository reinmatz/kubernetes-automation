---
# Nextcloud Ingress - HTTPS mit TLS
# Erfordert:
# - Nginx Ingress Controller
# - Cert-Manager (für automatische Zertifikate)
# - DNS-Eintrag: nextcloud.yourdomain.com → Ingress-IP
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nextcloud
  namespace: nextcloud-prod
  labels:
    app: nextcloud

  annotations:
    # Ingress Class
    kubernetes.io/ingress.class: nginx

    # Cert-Manager: Automatische TLS-Zertifikat-Erstellung
    # HINWEIS: Certificate wird separat in 08-tls-certificate.yaml erstellt
    # cert-manager.io/cluster-issuer: "selfsigned"

    # Nginx-spezifische Einstellungen
    nginx.ingress.kubernetes.io/proxy-body-size: "10g"  # Max. 10GB Uploads
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    nginx.ingress.kubernetes.io/proxy-request-buffering: "off"

    # Timeouts für große Datei-Uploads
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"

    # HSTS (HTTP Strict Transport Security)
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # NOTE: CalDAV/CardDAV redirects removed due to snippet restrictions
    # Nextcloud handles /.well-known redirects internally since v21+
    # If needed, configure these in Nextcloud's .htaccess or config.php

    # Rate Limiting (optional, schützt vor Brute-Force)
    # nginx.ingress.kubernetes.io/limit-rps: "10"
    # nginx.ingress.kubernetes.io/limit-connections: "20"

spec:
  ingressClassName: nginx

  # TLS-Konfiguration
  tls:
  - hosts:
    - nextcloud.home16.local
    secretName: nextcloud-tls-secret  # Wird von Cert-Manager erstellt (siehe 08-tls-certificate.yaml)

  # Routing-Regeln
  rules:
  # Default rule (no host) - matches localhost and IP access
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nextcloud  # Service-Name
            port:
              number: 80
  # Named host rule
  - host: nextcloud.home16.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nextcloud
            port:
              number: 80

---
# Alternative: Ingress ohne TLS (nur für Testing!)
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: nextcloud-http
#   namespace: nextcloud-prod
#   annotations:
#     nginx.ingress.kubernetes.io/proxy-body-size: "10g"
#     nginx.ingress.kubernetes.io/ssl-redirect: "false"
# spec:
#   ingressClassName: nginx
#   rules:
#   - host: nextcloud.local
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: nextcloud
#             port:
#               number: 80
